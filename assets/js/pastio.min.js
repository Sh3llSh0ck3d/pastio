/**
 * Pastio
 * http://cixtor.com/
 * http://cixtor.com/pastio
 * https://github.com/cixtor/pastio
 *
 * Multi-platform desktop application built on top of node-webkit, node.js and a
 * public webservice maintained by cixtor.com to paste and visualize text/plain
 * files like source code, markdown files, plain text documents and publish them
 * public or privately for an unlimited time in a remote database and share those
 * files using a unique link identifier.
 */

(function(){
    var Pastio = {
        appconfig: require('./package.json'),
        gui: require('nw.gui'),
        editor: false,
        remote_server: 'http://localhost:8000',
        default_mode: 'php',
        current_mode: '',

        get_window: function(){
            return this.gui.Window.get();
        },

        load_interface: function(){
            var gui = this.gui;
            var win = this.get_window();
            var instance = this;

            // Native menu application.
            var menu = new gui.Menu({type: 'menubar'})
                , submenu_file = new gui.Menu()
                , submenu_view = new gui.Menu()
                , submenu_syntax = new gui.Menu()
                , submenu_help = new gui.Menu();

            var file = menu.append(new gui.MenuItem({ label: 'File', submenu: submenu_file }));
            var view = menu.append(new gui.MenuItem({ label: 'View', submenu: submenu_view }));
            var help = menu.append(new gui.MenuItem({ label: 'Help', submenu: submenu_help }));

            submenu_file.append( new gui.MenuItem({ label: 'New', click: function(){ instance.reset_editor() } }) );
            submenu_file.append( new gui.MenuItem({ label: 'Save', click: function(){ instance.upload_code() } }) );
            submenu_file.append( new gui.MenuItem({ label: 'Exit', click: function(){ win.close() }}) );

            submenu_view.append( new gui.MenuItem({ label: 'Word wrapping', click: function(){ instance.word_wrap() }}) );
            submenu_view.append( new gui.MenuItem({ label: 'Syntax', submenu: submenu_syntax }));

            submenu_help.append( new gui.MenuItem({ label: 'Author', click: function(){ instance.help_author() }}) );
            submenu_help.append( new gui.MenuItem({ label: 'Donate', click: function(){ instance.help_donate() }}) );
            submenu_help.append( new gui.MenuItem({ label: 'Source code', click: function(){ instance.help_source_code() }}) );
            submenu_help.append( new gui.MenuItem({ label: 'Request feature', click: function(){ instance.help_request_feature() }}) );

            var syntax = instance.get_modes();
            $.each(syntax.modes, function(key, value){
                submenu_syntax.append( new gui.MenuItem({ label:value, click:function(){ instance.set_editor_mode(value) }}) );
            });

            win.menu = menu;

            win.on('close', function(){
                this.hide();
                console.log('Closing app...');
                this.close(true);
            });
        },

        initialize_editor: function(){
            var instance = this;
            instance.editor = ace.edit('pastioeditor');
            instance.editor.setTheme('ace/theme/monokai');
            instance.set_editor_mode(instance.current_mode);
            instance.fill_statusbar();
        },

        set_editor_mode: function(mode){
            mode = mode=='' ? this.default_mode : mode;
            this.editor.getSession().setMode('ace/mode/'+mode);
            this.current_mode = mode;
            $('#pastio-bottom .current-mode').html('Syntax: '+mode);
        },

        get_editor_content: function(){
            return this.editor.getValue();
        },

        get_editor_mode: function(){
            return this.editor.getSession().getMode();
        },

        reset_editor: function(){
            this.editor.setValue('');
        },

        upload_code: function(){
            var instance = this;
            var data_json = {
                code: instance.get_editor_content(),
                mode: instance.current_mode
            };
            $.ajax({
                url: instance.remote_server+'/pastio/save',
                type: 'POST',
                dataType: 'json',
                data: data_json,
                success: function(data, textStatus, jqXHR){
                    if( data.status==1 ){ instance.reset_editor() }
                    $('#pastio-modal .modal-header .modal-title').html(data.message_title);
                    $('#pastio-modal .modal-body').html(data.message_body);
                    $('#pastio-modal').modal('show');
                }
            });
        },

        word_wrap: function(){
            var instance = this;
            var current_mode = $('#pastio-bottom .word-wrapping').data('wordwrap');
            var mode = ( current_mode == 'true' ) ? false : true;
            instance.set_word_wrapping(mode);
        },

        set_word_wrapping: function(mode){
            var local_storage_key = 'pastio-word-wrapping';
            if( mode == undefined ){
                var user_chosen = localStorage.getItem(local_storage_key);
                if( user_chosen == null ){
                    mode = this.default_word_wrapping;
                }else{
                    mode = ( user_chosen == 'true' ) ? true : false;
                }
            }
            this.editor.getSession().setUseWrapMode(mode);
            localStorage.setItem('pastio-word-wrapping', mode);

            var word_wrapping_state = ( mode == true ) ? 'true' : 'false';
            $('#pastio-bottom .word-wrapping')
                .data('wordwrap', word_wrapping_state)
                .html('Word wrapping: ' + word_wrapping_state);
        },

        help_author: function(){
            this.gui.Shell.openExternal('https://plus.google.com/+YormanArias');
        },

        help_donate: function(){
            this.gui.Shell.openExternal('https://www.gittip.com/cixtor/');
        },

        help_source_code: function(){
            this.gui.Shell.openExternal('https://github.com/cixtor/pastio');
        },

        help_request_feature: function(){
            this.gui.Shell.openExternal('https://github.com/cixtor/pastio/issues/new');
        },

        fill_statusbar: function(){
            var instance = this;
            var editor = instance.editor;
            editor.getSession().on('change', function(){
                var number_of_lines = instance.get_number_of_lines();
                $('#pastio-bottom .total-lines').html('Total lines: '+number_of_lines);

                // var current_line = instance.get_current_line();
                // $('#pastio-bottom .current-line').html('Current line '+(current_line.row+1));
                // $('#pastio-bottom .column-number').html('Column '+(current_line.column+1));

                var number_of_chars = instance.get_number_of_chars();
                $('#pastio-bottom .total-chars').html('Chars: '+number_of_chars);
            });

            instance.set_word_wrapping();
        },

        get_number_of_lines: function(){
            return this.editor.session.getLength();
        },

        get_current_line: function(){
            return this.editor.selection.getCursor();
        },

        get_number_of_chars: function(){
            return this.get_editor_content().length;
        },

        get_modes: function(){
            var modes = {
                'default_mode': 'php',
                'modes': [
                    'abap','actionscript','ada','asciidoc','assembly_x86','autohotkey','batchfile','c9search','c_cpp',
                    'clojure','cobol','coffee','coldfusion','csharp','css','curly','dart','diff','django','d','dot',
                    'ejs','erlang','forth','ftl','glsl','golang','groovy','haml','handlebars','haskell','haxe',
                    'html_completions','html','html_ruby','ini','jack','jade','java','javascript','jsoniq','json',
                    'jsp','jsx','julia','latex','less','liquid','lisp','livescript','logiql','lsl','lua','luapage',
                    'lucene','makefile','markdown','matlab','mushcode_high_rules','mushcode','mysql','nix','objectivec',
                    'ocaml','pascal','perl','pgsql','php','plain_text','powershell','prolog','properties','protobuf',
                    'python','rdoc','rhtml','r','ruby','rust','sass','scad','scala','scheme','scss','sh','sjs',
                    'snippets','soy_template','space','sql','stylus','svg','tcl','tex','textile','text','toml','twig',
                    'typescript','vbscript','velocity','verilog','xml','xquery','yaml'
                ]
            };
            return modes;
        }
    };

    Pastio.load_interface();
    Pastio.initialize_editor();
})();
