/**
 * Pastio
 * http://www.cixtor.com/
 * https://github.com/cixtor/pastio
 *
 * Multi-platform desktop application built on top of node-webkit, node.js and a
 * public webservice maintained by cixtor.com to paste and visualize text/plain
 * files like source code, markdown files, plain text documents and publish them
 * public or privately for an unlimited time in a remote database and share those
 * files using a unique link identifier.
 */

(function(){
    var Pastio = {
        appconfig: require('./package.json'),
        gui: require('nw.gui'),
        editor: false,
        default_mode: 'php',
        current_mode: '',

        get_window: function(){
            return this.gui.Window.get();
        },

        load_interface: function(){
            var gui = this.gui;
            var win = this.get_window();
            var instance = this;

            // Native menu application.
            var menu = new gui.Menu({type: 'menubar'})
                , submenu_file = new gui.Menu()
                , submenu_syntax = new gui.Menu()
                , submenu_help = new gui.Menu();

            var file = menu.append(new gui.MenuItem({ label: 'File', submenu: submenu_file }));
            var help = menu.append(new gui.MenuItem({ label: 'Help', submenu: submenu_help }));

            submenu_file.append( new gui.MenuItem({ label: 'New', click: function(){ instance.reset_editor() } }) );
            submenu_file.append( new gui.MenuItem({ label: 'Syntax', submenu: submenu_syntax }));
            submenu_file.append( new gui.MenuItem({ label: 'Exit', click: function(){ win.close() }}) );
            submenu_help.append( new gui.MenuItem({ label: 'About', click: function(){ alert('Node Webkit Demo App') }}) );

            var syntax = instance.get_modes();
            $.each(syntax.modes, function(key, value){
                submenu_syntax.append( new gui.MenuItem({ label:value, click:function(){ instance.set_editor_mode(value) }}) );
            });

            win.menu = menu;

            win.on('close', function(){
                this.hide();
                console.log('Closing app...');
                this.close(true);
            });
        },

        initialize_editor: function(){
            var instance = this;
            instance.editor = ace.edit('pastioeditor');
            instance.editor.setTheme('ace/theme/monokai');
            instance.set_editor_mode(instance.current_mode);
            instance.fill_statusbar();
        },

        set_editor_mode: function(mode){
            mode = mode=='' ? this.default_mode : mode;
            this.editor.getSession().setMode('ace/mode/'+mode);
            this.current_mode = mode;
            $('#pastio-bottom .current-mode').html('Syntax: '+mode);
        },

        get_editor_content: function(){
            return this.editor.getValue();
        },

        get_editor_mode: function(){
            return this.editor.getSession().getMode();
        },

        reset_editor: function(){
            this.editor.setValue('');
        },

        fill_statusbar: function(){
            var instance = this;
            var editor = instance.editor;
            editor.getSession().on('change', function(){
                var number_of_lines = instance.get_number_of_lines();
                $('#pastio-bottom .total-lines').html('Total lines: '+number_of_lines);

                // var current_line = instance.get_current_line();
                // $('#pastio-bottom .current-line').html('Current line '+(current_line.row+1));
                // $('#pastio-bottom .column-number').html('Column '+(current_line.column+1));

                var number_of_chars = instance.get_number_of_chars();
                $('#pastio-bottom .total-chars').html('Chars: '+number_of_chars);
            });
        },

        get_number_of_lines: function(){
            return this.editor.session.getLength();
        },

        get_current_line: function(){
            return this.editor.selection.getCursor();
        },

        get_number_of_chars: function(){
            return this.get_editor_content().length;
        },

        get_modes: function(){
            var modes = {
                'default_mode': 'php',
                'modes': [
                    'abap','actionscript','ada','asciidoc','assembly_x86','autohotkey','batchfile','c9search','c_cpp',
                    'clojure','cobol','coffee','coldfusion','csharp','css','curly','dart','diff','django','d','dot',
                    'ejs','erlang','forth','ftl','glsl','golang','groovy','haml','handlebars','haskell','haxe',
                    'html_completions','html','html_ruby','ini','jack','jade','java','javascript','jsoniq','json',
                    'jsp','jsx','julia','latex','less','liquid','lisp','livescript','logiql','lsl','lua','luapage',
                    'lucene','makefile','markdown','matlab','mushcode_high_rules','mushcode','mysql','nix','objectivec',
                    'ocaml','pascal','perl','pgsql','php','plain_text','powershell','prolog','properties','protobuf',
                    'python','rdoc','rhtml','r','ruby','rust','sass','scad','scala','scheme','scss','sh','sjs',
                    'snippets','soy_template','space','sql','stylus','svg','tcl','tex','textile','text','toml','twig',
                    'typescript','vbscript','velocity','verilog','xml','xquery','yaml'
                ]
            };
            return modes;
        }
    };

    Pastio.load_interface();
    Pastio.initialize_editor();
})();
